# k8s storage
## emptyDir

### 개요

- 초기 컨테이너 환경에서 임시 데이터를 저장할 공간이 필요했지만 컨테이너가 종료되면 함께 사라지도록 하고자 할 때 사용하던 “임시 볼륨” 개념에서 출발함
- k8s가 등장하면서 pod 단위에서 이러한 임시 저장소를 제공하기 위해 emptyDir 볼륨 타입을 지원하게 됨

### 동작 방식

1. Pod가 특정 노드에서 생성됨과 동시에 워커노드의 파일 시스템 상의 디렉토리 하나 만들어짐
2. 파드 내 컨테이너들은 이를 마운트 받아서 공용 임시 저장공간처럼 활용할 수 있음
3. 파드가 종료되거나 제거되면 해당 emptyDir도 함께 영구 삭제 됨

즉, 파드 생명주기와 1대1로 동작하는 휘발성 스토리지

**어떤 범위까지 볼륨이 유효할까?를 생각해보기**

- 파드 안에서만 유효한게 emptyDir
- 파드 안의 컨테이너끼리 볼륨 공유하고, 파드끼리 볼륨을 공유하지는 않음.
- 파드 종료되면 볼륨도 날라감!!
    - 운영 환경에선 쓰지 말자. 로그도 재산이다.
- 용도 : 일시적 데이터 필요할 때 적합

## hostPath

- Host의 파일시스템 경로(path)에서 유래
- 노드(서버) 자체의 파일시스템 일부를 컨테이너가 직접 마운트해서 사용하는 방식

- 여러 노드가 있는 환경에서 **반드시** 두 Pod 모두 동일 노드에서 실행되도록 하려면 아래와 같이`nodeSelector`를 이용해야한다

- 해당 노드의 로컬 파일시스템을 직접 사용
- 노드 디렉토리를 바로 사용하므로 복잡도 낮음
- 로컬에서 개발할 때, 호스트 파일시스템과 컨테이너를 공유하고자 할 때 유용
- 하지만 프로덕션 환경에선 PV 등을 사용해 다른 방식으로 관리하는 것을 권장

## **PersistentVolume(PV) &** **PersistentVolumeClaim (PVC)**

관리자가 PV, 개발자가 PVC

- Claim : 개발자가 (또는 애플리케이션이) 필요한 스토리지를 요청하는 것

- PV : 클러스터에서 관리되는 실제 스토리지 리소스
- PVC : 필요한 요구사항을 기술해 PV를 할당받을 수 있게 하는 요청
- 파드는 PVC를 마운트함으로써 **영구 스토리지**를 활용할 수 있게 됨

### 동작 방식 설명

- PV 생성 : 클러스터에 이 만큼의 스토리지 자원을 등록한다
- PVC 생성 : 이런 용량, 접근 모드로 스토리지를 쓰겠다
- 바인딩 : PVC 요구 사항을 충족하는 PV가 있으면 자동으로 연결
- 파드에서 PVC 사용 : Pod 스펙에 persistentVolumeClaim만 써주면 실제 물리 스토리지를 자동으로 마운트해 사용
- 파드가 죽어도 PV는 남아있음. PVC가 계속 PV를 유지 (또는 새로운 파드가 동일 PVC를 재마운트)할 수 있음

## 특징

- 파드가 재시작되거나 삭제되어도 데이터 보존할 수 있음
- PV는 클러스터 자원으로 독립적으로 존재. PVC는 그 PV를 청구하는 개념
- 따라서 파드를 삭제해도 PVC,PV는 남아있을 수 있고, PVC를 삭제하면 PV가 `released` 등 특정 상태로 바뀔 수 있음
- 여러 access 모드 있음.
    - 단일 노드 읽기/쓰기 가능
    - 여러 노드 읽기 가능, 단일 노드 쓰기 가능
    - 여러 노드 읽기/쓰기 가능
- 사용자가 PVC만 작성하면 적절한 `StorageClass`를 통해 PV가 자동으로 생성, 할당 됨

## NFS

- 네트워크 상의 원격 파일시스템을 로컬 디렉토리처럼 마운트해서 사용할 수 있게 해주는 프로토콜
- k8s에서도 외부 스토리지로 NFS 서버를 사용해 데이터 PVC로 가져올 수 있음
